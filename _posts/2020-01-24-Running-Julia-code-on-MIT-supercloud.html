---
layout: post 
title: Running Julia code on MIT Supercloud
categories: [programming] 
tags: [Julia]
comments: true 
---
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this blog, we are going to discuss how to MIT supercloud to run simple Julia code.</p>
<p>As an illustrative example, we will use Julia code that uses lasso to approximately solve a sparse regression problem.<!-- more --> To understand what is going in the code, please take a look at my previous blog <a href="https://shuvomoy.github.io/blog/programming/2020/01/23/Solving-sparse-regression-using-lasso.html">here</a>.</p>
<h2 id="Julia-code">Julia code<a class="anchor-link" href="#Julia-code">&#182;</a></h2><p>The code for the julia file is given below, please save it in a text file and name it <code>lasso.jl</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="c">## Please copy the code in this code block and save it as lasso.jl</span>
<span class="n">println</span><span class="p">(</span><span class="s">&quot;lasso.jl is running&quot;</span><span class="p">)</span>
<span class="n">println</span><span class="p">(</span><span class="s">&quot;********************&quot;</span><span class="p">)</span>

<span class="c">## The following function is used to compute cardinality of a vector.</span>
<span class="k">function</span> <span class="n">l_0_norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">delta_l0_norm</span><span class="p">)</span>
    <span class="n">diffxy</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">y</span>
    <span class="n">l_0_norm_xy</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="kp">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">n</span>
        <span class="k">if</span> <span class="n">abs</span><span class="p">(</span><span class="n">diffxy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">delta_l0_norm</span>
            <span class="n">l_0_norm_xy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">sum</span><span class="p">(</span><span class="n">l_0_norm_xy</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">card</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">delta_l0_norm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">l_0_norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">n</span><span class="p">,</span><span class="n">delta_l0_norm</span><span class="p">)</span>
<span class="k">end</span>

<span class="c">## Data</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">)</span>

<span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

<span class="n">λ_glment_array</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">.^</span><span class="p">(</span><span class="n">range</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">stop</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>

<span class="n">k</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c">## running lasso using glmnet</span>
<span class="k">using</span> <span class="n">GLMNet</span><span class="p">,</span> <span class="n">LinearAlgebra</span>

<span class="n">path</span> <span class="o">=</span> <span class="n">glmnet</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">lambda</span> <span class="o">=</span> <span class="n">λ_glment_array</span><span class="p">)</span>

<span class="n">matrix_x</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="kt">Matrix</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">betas</span><span class="p">)</span>

<span class="c">## finding glmnet smallest</span>

<span class="n">λ_glmnet_smallest</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">x_glmnet</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="n">m1</span><span class="p">,</span> <span class="n">n1</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">matrix_x</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="kp">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">n1</span>
    <span class="n">cardinality_present</span> <span class="o">=</span> <span class="n">card</span><span class="p">(</span><span class="n">matrix_x</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="n">i</span><span class="p">],</span> <span class="n">m1</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">)</span>
    <span class="n">println</span><span class="p">(</span><span class="s">&quot;cardinality of the &quot;</span><span class="p">,</span> <span class="n">i</span> <span class="p">,</span> <span class="s">&quot;-th solution is = &quot;</span><span class="p">,</span> <span class="n">cardinality_present</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cardinality_present</span> <span class="o">&lt;=</span> <span class="n">k</span>
        <span class="n">println</span><span class="p">(</span><span class="s">&quot;card(signal) =&quot;</span><span class="p">,</span> <span class="n">cardinality_present</span><span class="p">,</span> <span class="s">&quot; found for λ = &quot;</span><span class="p">,</span>  <span class="n">λ_glment_array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="kd">global</span> <span class="n">λ_glmnet_smallest</span> <span class="o">=</span>  <span class="n">λ_glment_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">println</span><span class="p">(</span><span class="s">&quot; corresponding solution x is = &quot;</span><span class="p">,</span> <span class="n">matrix_x</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
        <span class="kd">global</span> <span class="n">x_glmnet</span> <span class="o">=</span> <span class="n">matrix_x</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
        <span class="k">break</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">λ_smallest</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="n">λ_glmnet_smallest</span>

<span class="c">## check objecgive value</span>
<span class="n">obj_glmnet</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">x_glmnet</span> <span class="o">-</span> <span class="n">b</span><span class="p">))</span><span class="o">^</span><span class="mi">2</span>

<span class="c"># finding the index of nonzero elements</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="n">iszero</span><span class="p">,</span> <span class="n">x_glmnet</span><span class="p">)</span>
<span class="n">k</span> <span class="o">==</span> <span class="n">n</span> <span class="o">-</span> <span class="n">length</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>

<span class="c">##</span>
<span class="k">using</span> <span class="n">SCS</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">SCSSolver</span><span class="p">()</span>
<span class="k">using</span> <span class="n">Convex</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">objective</span> <span class="o">=</span> <span class="n">sumsquares</span><span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>
<span class="n">problem</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">objective</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">constraints</span> <span class="o">+=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">Z</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">]</span>
<span class="k">end</span>
<span class="n">solve!</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">solver</span><span class="p">)</span>
<span class="n">x_convex</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span>

<span class="k">function</span> <span class="n">polish</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x_polished</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">for</span> <span class="n">i</span> <span class="kp">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">n</span>
        <span class="k">if</span> <span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mf">1e-5</span>
            <span class="n">x_polished</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">x_polished</span>
<span class="k">end</span>

<span class="n">x_convex_polished</span> <span class="o">=</span> <span class="n">polish</span><span class="p">(</span><span class="n">x_convex</span><span class="p">)</span>

<span class="n">obj_convex</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">x_convex_polished</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span>

<span class="k">using</span> <span class="n">JLD2</span>

<span class="n">println</span><span class="p">(</span><span class="s">&quot;saving the data now...&quot;</span><span class="p">)</span>

<span class="nd">@save</span> <span class="s">&quot;lasso_data.jld2&quot;</span> <span class="n">A</span> <span class="n">b</span> <span class="n">λ_glment_array</span> <span class="n">x_glmnet</span> <span class="n">x_convex_polished</span> <span class="n">obj_glmnet</span> <span class="n">obj_convex</span>

<span class="n">println</span><span class="p">(</span><span class="s">&quot;done running the code :)&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Shell-script-to-submit-the-job">Shell script to submit the job<a class="anchor-link" href="#Shell-script-to-submit-the-job">&#182;</a></h2><p>Now we are going to create a shell script that will be used to submit the job. The code for the shell script is below. Please save it in a text file, and name it <code>run_lasso.sh</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="c">#!/bin/sh</span>

<span class="c"># Initialize Modules</span>
<span class="n">source</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">profile</span>

<span class="c"># Load Julia Module</span>
<span class="k">module</span> <span class="n">load</span> <span class="n">julia</span><span class="o">-</span><span class="n">latest</span>

<span class="c"># Call your script as you would from the command line</span>
<span class="n">julia</span> <span class="n">lasso</span><span class="o">.</span><span class="n">jl</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Submitting-the-job">Submitting the job<a class="anchor-link" href="#Submitting-the-job">&#182;</a></h2><p>Now log in to MIT supercloud, copy the files created above to your working directory, and run the following command.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="n">LLsub</span> <span class="n">run_lasso</span><span class="o">.</span><span class="n">sh</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="If-we-need-more-memory">If we need more memory<a class="anchor-link" href="#If-we-need-more-memory">&#182;</a></h2><p>Here we should keep in mind that MIT supercloud nodes have 16 cores and 64 GB of RAM in total. As a result, each core has about 4 GB. So if our job requires a certain amount of memory, we need to allocate memeory accordingly. For example, if our program needs roughly 32 GB memeory, then we need to allocate 8 cores, which can be done by running the following command.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="n">LLsub</span> <span class="n">myScript</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">s</span> <span class="mi">8</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Observing-the-status-of-the-submitted-job">Observing the status of the submitted job<a class="anchor-link" href="#Observing-the-status-of-the-submitted-job">&#182;</a></h2><p>After submitting the job, we can check the status of our jobs by running the following command</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="n">LLstat</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>which will have an output like:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="n">LLGrid</span><span class="o">:</span> <span class="n">txe1</span> <span class="p">(</span><span class="n">running</span> <span class="n">slurm</span> <span class="mf">19.05</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span>
<span class="n">JOBID</span>     <span class="n">ARRAY_J</span>    <span class="n">NAME</span>         <span class="n">USER</span>     <span class="n">START_TIME</span>          <span class="n">PARTITION</span>  <span class="n">CPUS</span>  <span class="n">FEATURES</span>  <span class="n">MIN_MEMORY</span>  <span class="n">ST</span>  <span class="n">NODELIST</span><span class="p">(</span><span class="n">REASON</span><span class="p">)</span>
<span class="mi">17019</span>     <span class="mi">40986</span>      <span class="n">run_lasso</span>       <span class="n">Student</span>  <span class="mi">2020</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span><span class="n">T15</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mi">46</span> <span class="n">normal</span>     <span class="mi">1</span>     <span class="n">xeon</span><span class="o">-</span><span class="n">e5</span>   <span class="mi">5</span><span class="n">G</span>          <span class="n">R</span>   <span class="n">gpu</span><span class="o">-</span><span class="mi">2</span>
<span class="mi">17214</span>     <span class="mi">40980</span>      <span class="n">myJob1</span>       <span class="n">Student</span>  <span class="mi">2020</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span><span class="n">T15</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mi">37</span> <span class="n">normal</span>     <span class="mi">1</span>     <span class="n">xeon</span><span class="o">-</span><span class="n">e5</span>   <span class="mi">5</span><span class="n">G</span>          <span class="n">R</span>   <span class="n">gpu</span><span class="o">-</span><span class="mi">2</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Killing-a-job">Killing a job<a class="anchor-link" href="#Killing-a-job">&#182;</a></h2><p>If we want to kill one of the jobs, e.g., <code>run_lasso</code>, then we can do that by running the following command:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="n">LLkill</span> <span class="mi">17019</span>
</pre></div>

    </div>
</div>
</div>

</div>
 

